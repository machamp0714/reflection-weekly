# Implementation Plan

## 完了条件（Definition of Done）

各タスクは以下の条件を満たした場合に完了とする：

1. **Lintチェック**: 全てのLintがパスしていること（`npm run lint`が成功）
2. **コミット**: Lintがパスしたら、タスク完了時にコミットすること
3. **API疎通確認**: Task 2（外部APIクライアント）完了時、手動で各API（GitHub、Toggl、OpenAI、Notion）との疎通が確認できる状態になっていること

## Tasks

- [x] 1. プロジェクト基盤とInfrastructure層の設定管理を構築する
- [x] 1.1 (P) TypeScript/Node.jsプロジェクトを初期化する
  - Node.js 20 LTS、TypeScript 5.4のプロジェクト構成を作成する
  - 厳格な型チェック（strict mode）を有効化する
  - ESLint、Prettier等の開発ツールを設定する
  - ビルドスクリプトとパッケージマネージャを設定する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 1.2 (P) 設定管理機能を実装する
  - 環境変数からAPI認証情報（GitHub、Toggl、Notion、OpenAI）を読み込む
  - cosmiconfig経由で設定ファイルをサポートする
  - 環境変数を設定ファイルより優先するマージロジックを実装する
  - 振り返り対象期間（デフォルト7日間）とリポジトリリストの設定を管理する
  - ChatGPTモデル設定（デフォルトgpt-4o）を管理する
  - スケジュール実行の曜日・時刻設定（デフォルト日曜19:00）を管理する
  - ログ出力先パス設定を管理する
  - 必須設定の検証と不足項目の明示的なエラー表示を実装する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10_

- [x] 1.3 (P) ファイルロガーを実装する
  - pinoを使用した構造化ログ出力を実装する
  - 設定可能なログ出力先パスをサポートする
  - ログローテーション機能を実装する
  - 実行開始・完了・エラーのログ記録インターフェースを提供する
  - 機密情報（トークン）のマスキング処理を実装する
  - _Requirements: 9.3, 9.4, 9.6_

- [x] 2. 外部APIクライアントを実装する
- [x] 2.1 (P) GitHubクライアントを実装する
  - GitHub REST APIとの通信機能を実装する
  - Personal Access Tokenによる認証を実装する
  - 指定期間のコミット履歴取得機能を実装する
  - コミットメッセージ、日時、リポジトリ名、変更ファイル数の抽出を実装する
  - 複数リポジトリからの履歴取得をサポートする
  - ページネーション処理を実装する
  - API接続失敗時のエラーハンドリングとリトライ（3回、指数バックオフ）を実装する
  - コミット不在時の通知メッセージを生成する
  - レート制限（5,000 req/hour）対応を実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 (P) Togglクライアントを実装する
  - Toggl Track API v9との通信機能を実装する
  - Basic認証（APIトークン）を実装する
  - 指定期間のタイムエントリ取得機能を実装する
  - プロジェクト名、タスク説明、作業時間、日時の抽出を実装する
  - プロジェクト情報の取得とキャッシュを実装する
  - API接続失敗時のエラーハンドリングとリトライを実装する
  - 打刻データ不在時の通知メッセージを生成する
  - 実行中エントリ（duration負値）の除外処理を実装する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 2.3 (P) OpenAIクライアントを実装する
  - OpenAI Chat Completions APIとの通信機能を実装する
  - Bearer Token認証を実装する
  - 設定可能なモデル選択（デフォルトgpt-4o）をサポートする
  - 活動サマリー生成用のプロンプト設計と実装を行う
  - KPT提案生成用のプロンプト設計と実装を行う
  - トークン管理とレスポンス制限対応を実装する
  - API障害時のエラーハンドリングとリトライを実装する
  - レート制限対応を実装する
  - _Requirements: 3.2, 3.4, 5.5, 7.5_

- [x] 2.4 (P) Notionクライアントを実装する
  - Notion APIとの通信機能を実装する
  - Bearer Token認証とNotionバージョンヘッダー設定を実装する
  - データベースへのページ作成機能を実装する
  - ブロックベースのコンテンツ（見出し、段落、リスト等）構築を実装する
  - 既存ページのクエリ機能（前週参照用）を実装する
  - API接続失敗時のエラーハンドリングとリトライを実装する
  - レート制限（3 req/sec）対応のリクエストキューを実装する
  - 作成したページのURL取得を実装する
  - _Requirements: 4.1, 4.5, 4.6, 6.1, 6.2_

- [x] 3. Domain層のビジネスロジックを実装する
- [x] 3.1 データ統合機能を実装する
  - GitHubとTogglからのデータ並列収集を実装する
  - 両データソースの時系列統合を実装する
  - 日別の活動サマリー集計を実装する
  - プロジェクト別の活動量（コミット数、作業時間）集計を実装する
  - いずれかのデータソースが空の場合の継続処理を実装する
  - 部分的データ取得失敗時の警告生成とグレースフル継続を実装する
  - 2.1と2.2に依存
  - _Requirements: 1.4, 2.4, 2.5, 3.1, 3.5, 3.7_

- [x] 3.2 活動分析機能を実装する
  - OpenAI APIを使用した日別活動サマリー生成を実装する
  - コミット内容と作業時間からの主要成果・活動の自然言語要約を実装する
  - コミット数と作業時間の相関分析・洞察生成を実装する
  - 収集データに基づくKPT（Keep/Problem/Try）提案の自動生成を実装する
  - 週ごとの活動量推移サマリー生成を実装する
  - OpenAI API障害時のAI分析なし基本サマリー生成フォールバックを実装する
  - 2.3と3.1に依存
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6, 5.5, 6.3_

- [x] 3.3 振り返りページ構築機能を実装する
  - Notionページの構造（タイトル、プロパティ、ブロック）構築を実装する
  - 週の開始日と終了日を含むタイトル生成を実装する
  - GitHubコミットサマリーセクションを生成する
  - Toggl作業時間サマリーセクションを生成する
  - KPTセクション（Keep/Problem/Try）と入力用プレースホルダーを生成する
  - AI生成のKPT提案を各セクションに配置する
  - 前週のTry項目参照セクションを生成する
  - 週番号とタグの自動付与を実装する
  - 前週振り返りページが存在しない場合の処理を実装する
  - Notion API障害時のMarkdownファイル出力フォールバックを実装する
  - 2.4と3.2に依存
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 6.2, 6.4, 6.5_

- [ ] 4. Application層のユースケースを実装する
- [x] 4.1 振り返り生成ユースケースを実装する
  - データ収集、分析、ページ生成の順序制御を実装する
  - 設定読み込みと検証の統合を実装する
  - エラー発生時のフォールバック処理判断を実装する
  - 進捗状態の通知インターフェースを実装する
  - ドライランモード（Notionページ作成せずプレビュー）を実装する
  - 実行結果サマリーの生成を実装する
  - 3.1、3.2、3.3に依存
  - _Requirements: 3.6, 4.5, 8.4, 8.5_

- [ ] 5. Presentation層のCLIを実装する
- [ ] 5.1 メイン振り返りコマンドを実装する
  - Commander.jsを使用したコマンドライン引数解析を実装する
  - 期間指定オプション（開始日、終了日）を実装する
  - ドライランオプションを実装する
  - verboseオプションを実装する
  - 処理進捗状況のリアルタイム表示（スピナー）を実装する
  - 生成結果サマリーの整形出力を実装する
  - 作成したNotionページURLの表示を実装する
  - 4.1に依存
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5, 4.6_

- [ ] 5.2 スケジュール管理コマンドを実装する
  - スケジュール登録サブコマンドを実装する
  - スケジュール解除サブコマンドを実装する
  - cron互換スケジュール式のバリデーション（node-cron）を実装する
  - デフォルトスケジュール（毎週日曜日19:00）を設定可能にする
  - スケジュール状態確認機能を実装する
  - 1.2に依存
  - _Requirements: 9.1, 9.2, 9.5_

- [ ] 6. スケジュール実行機能を実装する
- [ ] 6.1 プラットフォーム固有のスケジューラ設定生成を実装する
  - macOS launchd用のplistファイル生成を実装する
  - Linux systemd用のtimer/serviceファイル生成を実装する
  - Linux cron用のcrontabエントリ生成を実装する
  - 各プラットフォームのインストール手順を提供する
  - 5.2に依存
  - _Requirements: 9.7_

- [ ] 6.2 スケジュール実行管理を実装する
  - スケジュール実行時の実行ログファイル出力を実装する
  - スケジュール実行失敗時のエラーログ記録を実装する
  - オプションの通知先への失敗通知を実装する
  - スケジュール完了時のNotionページURL記録を実装する
  - 実行履歴の追跡機能を実装する
  - 1.3と4.1に依存
  - _Requirements: 9.3, 9.4, 9.6_

- [ ] 7. 統合テストとエンドツーエンドテストを実装する
- [ ] 7.1 (P) 各クライアントのユニットテストを実装する
  - ConfigManagerの設定読込・検証・デフォルト値適用テストを実装する
  - GitHubClientのコミット取得・エラーハンドリングテストを実装する
  - TogglClientのタイムエントリ取得・エラーハンドリングテストを実装する
  - OpenAIClientのサマリー生成・フォールバックテストを実装する
  - NotionClientのページ作成・エラーハンドリングテストを実装する
  - FileLoggerのログ出力・ローテーションテストを実装する
  - ScheduleManagerのcron式バリデーション・設定生成テストを実装する
  - _Requirements: 1.3, 2.3, 3.6, 4.5, 7.10_

- [ ] 7.2 統合テストを実装する
  - データ統合ロジックの日別・プロジェクト別集計テストを実装する
  - 活動分析のAIサマリー生成テスト（モック使用）を実装する
  - ページ構築のNotionブロック生成・Markdown変換テストを実装する
  - 全体フローの正常系テストを実装する
  - 各API障害時のフォールバック動作テストを実装する
  - 7.1に依存
  - _Requirements: 3.6, 3.7, 4.5_

- [ ] 7.3 エンドツーエンドテストを実装する
  - CLIコマンドの引数解析・実行テストを実装する
  - ドライランモードのプレビュー出力テストを実装する
  - スケジュール登録・解除コマンドの動作テストを実装する
  - 7.2に依存
  - _Requirements: 8.1, 8.3, 8.4, 9.5_
